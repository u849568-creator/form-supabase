<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Accueil â€“ Produits</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background: #f3f3f3; }
    input { width: 100%; box-sizing: border-box; }
    button {
      padding: 6px 12px;
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background: #004999; }

    tr.expandable { cursor: pointer; }
    tr.details { background: #fafafa; }
    .details-content { padding: 10px; }
  </style>
</head>

<body>

<div class="top-bar">
  <div>
    <h2>ðŸ“¦ Produits</h2>
    <button onclick="window.location.href='new_product.html'">Ajouter un produit</button>
  </div>
  <button onclick="logout()">Se dÃ©connecter</button>
</div>

<table>
  <thead>
    <tr>
      <th><input id="fEAN" placeholder="EAN"></th>
      <th><input id="fLIBELLE" placeholder="LibellÃ©"></th>
      <th><input id="fCODE_S" placeholder="Code fournisseur"></th>
    </tr>
    <tr>
      <th>EAN</th>
      <th>LIBELLÃ‰</th>
      <th>CODE_S</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
const rows = document.getElementById("rows");
const fEAN = document.getElementById("fEAN");
const fLIBELLE = document.getElementById("fLIBELLE");
const fCODE_S = document.getElementById("fCODE_S");

/* =========================
   VOLET PAF â€“ MATRICE
   ========================= */
async function toggleDetails(productId, tr) {
  const next = tr.nextElementSibling;
  if (next && next.classList.contains("details")) {
    next.remove();
    return;
  }
  document.querySelectorAll("tr.details").forEach(r => r.remove());

  const { data, error } = await db
    .from("PAF")
    .select(`
      REFERENCEMENT,
      RESEAU:reseau_id (
        RESEAU
      ),
      ANNEE:annee_id (
        ANNEE
      )
    `)
    .eq("produit_id", productId);

  if (error) {
    alert(error.message);
    return;
  }

  if (!data || data.length === 0) {
    const r = document.createElement("tr");
    r.className = "details";
    r.innerHTML = `<td colspan="3">Aucune donnÃ©e PAF</td>`;
    tr.after(r);
    return;
  }

  // RÃ©seaux (colonnes)
  const reseaux = [...new Set(
    data.map(d => d.RESEAU?.LIBELLE).filter(Boolean)
  )];

  // AnnÃ©es (lignes, desc)
  const annees = [...new Set(
    data.map(d => d.ANNEE?.ANNEE)
  )].sort((a, b) => b - a);

  // Indexation
  const map = {};
  data.forEach(d => {
    const annee = d.ANNEE?.ANNEE;
    const reseau = d.RESEAU?.LIBELLE;
    if (annee && reseau) {
      map[`${annee}_${reseau}`] = d.REFERENCEMENT;
    }
  });

  // Construction HTML
  let html = `<table style="width:100%;border-collapse:collapse">`;
  html += `<tr><th>AnnÃ©e</th>`;
  reseaux.forEach(r => html += `<th>${r}</th>`);
  html += `</tr>`;

  annees.forEach(a => {
    html += `<tr><td><strong>${a}</strong></td>`;
    reseaux.forEach(r => {
      html += `<td>${map[`${a}_${r}`] ?? "-"}</td>`;
    });
    html += `</tr>`;
  });

  html += `</table>`;

  const detailsRow = document.createElement("tr");
  detailsRow.className = "details";
  detailsRow.innerHTML = `
    <td colspan="3">
      <div class="details-content">${html}</div>
    </td>
  `;
  tr.after(detailsRow);
}

/* =========================
   LISTE PRODUITS
   ========================= */
async function loadProduits() {
  const user = await checkAuth("index.html");
  if (!user) return;

  let query = db
    .from("PRODUIT")
    .select('id, "EAN", "LIBELLE", "CODE_S"')
    .order("id", { ascending: false })
    .limit(20);

  if (fEAN.value) query = query.ilike("EAN", `%${fEAN.value}%`);
  if (fLIBELLE.value) query = query.ilike("LIBELLE", `%${fLIBELLE.value}%`);
  if (fCODE_S.value) query = query.ilike("CODE_S", `%${fCODE_S.value}%`);

  const { data, error } = await query;
  if (error) {
    alert(error.message);
    return;
  }

  rows.innerHTML = "";
  data.forEach(p => {
    const tr = document.createElement("tr");
    tr.className = "expandable";
    tr.innerHTML = `
      <td>${p.EAN ?? ""}</td>
      <td>${p.LIBELLE ?? ""}</td>
      <td>${p.CODE_S ?? ""}</td>
    `;
    tr.onclick = () => toggleDetails(p.id, tr);
    rows.appendChild(tr);
  });
}

fEAN.oninput = loadProduits;
fLIBELLE.oninput = loadProduits;
fCODE_S.oninput = loadProduits;

loadProduits();
</script>

</body>
</html>
