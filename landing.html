<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Accueil â€“ Produits</title>

  <!-- Supabase + configuration centrale -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabaseClient.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; display: inline-block; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; }
    input { width: 100%; box-sizing: border-box; }
    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .filters th { background: #fafafa; }
    button {
      padding: 6px 12px;
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #004999;
    }

    tr.expandable { cursor: pointer; }
tr.details { background: #fafafa; }
.details-content {
  padding: 10px;
  font-size: 14px;
}
    
  </style>
</head>
<body>

<div class="top-bar">
  <div>
    <h2>ðŸ“¦ Produits</h2>
    <button onclick="window.location.href='new_product.html'">Ajouter un produit</button>
  </div>
  <button onclick="logout()">Se dÃ©connecter</button>
</div>

<table>
  <thead>
    <tr class="filters">
      <th><input id="fEAN" placeholder="Rechercher EAN"></th>
      <th><input id="fLIBELLE" placeholder="Rechercher libellÃ©"></th>
      <th><input id="fCODE_S" placeholder="Rechercher code fournisseur"></th>
    </tr>
    <tr>
      <th>EAN</th>
      <th>LIBELLÃ‰</th>
      <th>CODE_S</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
  const rows = document.getElementById("rows");
  const fEAN = document.getElementById("fEAN");
  const fLIBELLE = document.getElementById("fLIBELLE");
  const fCODE_S = document.getElementById("fCODE_S");

  async function toggleDetails(productId, tr) {
  const next = tr.nextElementSibling;

  // Si dÃ©jÃ  ouvert â†’ fermer
  if (next && next.classList.contains("details")) {
    next.remove();
    return;
  }

  // Ferme les autres volets ouverts
  document.querySelectorAll("tr.details").forEach(r => r.remove());

  // Charge infos PAF
const { data, error } = await db
  .from("PAF")
  .select(`
    REFERENCEMENT,
    RESEAU (
      RESEAU
    )
  `)
  .eq("produit_id", productId)
  .single();

  if (error) {
    alert(error.message);
    return;
  }

  const detailsRow = document.createElement("tr");
  detailsRow.className = "details";
  detailsRow.innerHTML = `
    <td colspan="3">
      <div class="details-content">
        <strong>RÃ©seau :</strong> ${data.RESEAU ?? "-"}<br>
        <strong>RÃ©fÃ©rencement :</strong> ${data.REFERENCEMENT ?? "-"}
      </div>
    </td>
  `;

  tr.after(detailsRow);
}


  async function loadProduits() {
    // VÃ©rifie l'utilisateur connectÃ© via le fichier partagÃ©
    const user = await checkAuth("index.html");
    if (!user) return;

    let query = db
      .from("PRODUIT")
      .select('id, "EAN", "LIBELLE", "CODE_S"')
      .order("id", { ascending: false })
      .limit(20);

    if (fEAN.value) query = query.ilike("EAN", `%${fEAN.value}%`);
    if (fLIBELLE.value) query = query.ilike("LIBELLE", `%${fLIBELLE.value}%`);
    if (fCODE_S.value) query = query.ilike("CODE_S", `%${fCODE_S.value}%`);

    const { data, error } = await query;
    if (error) {
      alert(error.message);
      return;
    }

    rows.innerHTML = "";
data.forEach(p => {
  const tr = document.createElement("tr");
  tr.className = "expandable";
  tr.innerHTML = `
    <td>${p.EAN ?? ""}</td>
    <td>${p.LIBELLE ?? ""}</td>
    <td>${p.CODE_S ?? ""}</td>
  `;
  tr.onclick = () => toggleDetails(p.id, tr);
  rows.appendChild(tr);
});
  }

  fEAN.oninput = loadProduits;
  fLIBELLE.oninput = loadProduits;
  fCODE_S.oninput = loadProduits;

  // Authentifie puis charge
  loadProduits();
</script>

</body>
</html>
