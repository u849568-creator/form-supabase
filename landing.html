<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Accueil â€“ Produits</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-bottom: 10px; display: inline-block; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 6px; }
    th { background: #f3f3f3; }
    input { width: 100%; box-sizing: border-box; }
    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .filters th { background: #fafafa; }
    button {
      padding: 6px 12px;
      background: #0066cc;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #004999;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div>
    <h2>ðŸ“¦ Produits</h2>
    <button onclick="window.location.href='new_product.html'">Ajouter un produit</button>
  </div>
  <button onclick="logout()">Se dÃ©connecter</button>
</div>

<table>
  <thead>
    <!-- Ligne filtres -->
    <tr class="filters">
      <th><input id="fEAN" placeholder="Rechercher EAN"></th>
      <th><input id="fLIBELLE" placeholder="Rechercher libellÃ©"></th>
      <th><input id="fCODE_S" placeholder="Rechercher code fournisseur"></th>
    </tr>
    <!-- En-tÃªtes -->
    <tr>
      <th>EAN</th>
      <th>LIBELLÃ‰</th>
      <th>CODE_S</th>
    </tr>
  </thead>
  <tbody id="rows"></tbody>
</table>

<script>
  const supabaseUrl = "https://cmwpwpiougayrizofnru.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtd3B3cGlvdWdheXJpem9mbnJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODQxMTUsImV4cCI6MjA4MzM2MDExNX0.wik4VvmF8oAasCZ6YZMbcrzaRKKYPMrYkZgb4en4E2A";
  const db = supabase.createClient(supabaseUrl, supabaseKey);

  const rows = document.getElementById("rows");
  const fEAN = document.getElementById("fEAN");
  const fLIBELLE = document.getElementById("fLIBELLE");
  const fCODE_S = document.getElementById("fCODE_S");

  // DÃ©connexion
  async function logout() {
    await db.auth.signOut();
    window.location.href = "login.html";
  }

  async function loadProduits() {
    const { data: { session } } = await db.auth.getSession();

    if (!session) {
      window.location.href = "login.html";
      return;
    }

    let query = db
      .from("PRODUIT")
      .select('id, "EAN", "LIBELLE", "CODE_S"')
      .order("id", { ascending: false })
      .limit(20);

    if (fEAN.value) {
      query = query.ilike("EAN", `%${fEAN.value}%`);
    }
    if (fLIBELLE.value) {
      query = query.ilike("LIBELLE", `%${fLIBELLE.value}%`);
    }
    if (fCODE_S.value) {
      query = query.ilike("CODE_S", `%${fCODE_S.value}%`);
    }

    const { data, error } = await query;
    if (error) {
      alert(error.message);
      return;
    }

    rows.innerHTML = "";
    data.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><a href="produit.html?id=${p.id}">${p.EAN ?? ""}</a></td>
        <td>${p.LIBELLE ?? ""}</td>
        <td>${p.CODE_S ?? ""}</td>
      `;
      rows.appendChild(tr);
    });
  }

  fEAN.oninput = loadProduits;
  fLIBELLE.oninput = loadProduits;
  fCODE_S.oninput = loadProduits;

  loadProduits();
</script>

</body>
</html>
